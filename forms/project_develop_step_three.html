<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>新建元房地产项目管理系统</title>
    <link rel="shortcut icon" href="images/logo_16px.ico" type="image/x-icon" />
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="../plugins/bootstrap/css/bootstrap.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../plugins/fontawesome/css/font-awesome.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../plugins/adminlte/css/AdminLTE.css">
    <!-- Theme color -->
    <link rel="stylesheet" href="../plugins/adminlte/css/skins/skin-red.css">
    <!-- Handson table -->
    <link rel="stylesheet" href="../plugins/handsontable/handsontable.full.min.css" />
    <!-- Common -->
    <link href="css/common.css" rel="stylesheet">
    <link href="css/flow.css" rel="stylesheet">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

	
	
	<style>
#outer {width:450px;margin:150px auto;}
#tab {overflow:hidden;zoom:1;background:#e5e5e5;}
#tab li {float:left;color:#000;;height:30px;cursor:pointer;	line-height:30px;padding:0 20px;}
#tab li.current {color:#000;background:#ccc;}
#content {border-top-width:0;}
#content ul {display:none;	margin:0 30px;padding:10px 0;}
	</style>
	
	
</head>

<!--
BODY TAG OPTIONS:
=================
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body class="hold-transition skin-red sidebar-mini sidebar-collapse">

    <!--头部-->
    <header class="main-header">
        <a href="javascript:;" title="新建元房地产项目管理系统" class="logo">
            <span style="display:inline-block; height:30px; line-height:30px; margin:12px 8px; padding-left:45px; background-image: url(../plugins/adminlte/img/logo.png);background-repeat: no-repeat"></span>
        </a>
        <nav class="navbar navbar-static-top" role="navigation">
            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <li class="dropdown user user-menu">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <img id="imgUserSmall" src="../plugins/adminlte/img/user.png" class="user-image" alt="用户头像">
                            <span id="spanNickName" class="hidden-xs">admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="user-header">
                                <img id="imgUserLarge" src="../plugins/adminlte/img/user.png" class="img-circle" alt="User Image">
                                <p id="pNickName">管理员</p>
                            </li>
                            <li class="user-footer">
                                <div style="text-align:center;">
                                    <a href="javascript:;" onclick="delUserInfo();" class="btn btn-default btn-flat">登出</a>
                                </div>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    
    <!--侧边栏-->
    <aside class="main-sidebar">
        <section class="sidebar">
            <ul class="sidebar-menu">
                <li style="background-image: url(../plugins/adminlte/img/logo.png);background-position:10px;  background-repeat: no-repeat; display:inline-block; height:50px; line-height:50px; padding-left:50px;"></li>
                <li>
                    <a href="javascript:;">
                        <i class="fa fa-building"></i> <span>项目管理入口</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="../base/project_done.html">已有项目</a></li>
                        <li><a href="../base/project_todo.html">待获取项目</a></li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="fa fa-folder-open"></i> <span>房源管理入口</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="../sale/sale_project.html">系统项目</a></li>
                        <li><a href="../sale/sale_build.html">房源管理</a></li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="fa fa-shopping-cart"></i> <span>销售管理入口</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="../sale/sale_pre.html">预售证</a></li>
                        <li><a href="../sale/sale_push.html">推盘</a></li>
                        <li><a href="../sale/sale_sign.html">签约</a></li>
                        <li><a href="../sale/sale_pay.html">回款</a></li>
                        <li><a href="../sale/sale_over.html">结转</a></li>
                    </ul>
                </li>
                <li>
                    <a href="javascript:;">
                        <i class="fa fa-user"></i> <span>客户管理入口</span>
                        <span class="pull-right-container">
                            <i class="fa fa-angle-left pull-right"></i>
                        </span>
                    </a>
                    <ul class="treeview-menu">
                        <li><a href="../sale/sale_custom.html">客户管理</a></li>
                        <li><a href="../sale/sale_visit.html">看房记录</a></li>
                        <li><a href="../sale/sale_vip.html">认筹管理</a></li>
                    </ul>
                </li>
            </ul>
        </section>
    </aside>

    <div class="content-wrapper clearfix">
        <ol id="olBreadcrumb" class="breadcrumb">
            <li><a href="project_done.html"><i class="fa fa-bookmark-o"></i> 项目管理入口</a></li>
            <li><a href="project_index.html">项目一览</a></li>
            <li><a href="project_develop_list.html">开发方案</a></li>
			<li class="active">编辑</li>
        </ol>

        <div style="width:100%;margin:0 auto;" class="pub-steps">
            <ul class="clearfix" style="padding:0;">
                <li style="width:16%;" class="step-on">
                    <span class="step-deco"></span>
                    <span class="step-val">1</span>
                    <span class="step-title">配置期数与土地</span>
                    <span class="step-time">第一步</span>
                </li>

                <li style="width:16%;" class="step-on">
                    <span class="step-deco"></span>
                    <span class="step-val">2</span>
                    <span class="step-title">选择产品类型</span>
                    <span class="step-time">第二步</span>
                </li>

                <li style="width:16%;" class="step-on">
                    <span class="step-deco"></span>
                    <span class="step-val">3</span>
                    <span class="step-title">编辑开发方案</span>
                    <span class="step-time">第三步</span>
                </li>

                <li style="width:16%;" class="step-next">
                    <span class="step-deco"></span>
                    <span class="step-val">4</span>
                    <span class="step-title">编辑成本分摊</span>
                    <span class="step-time">第四步</span>
                </li>

                <li style="width:16%;" class="step-next">
                    <span class="step-deco"></span>
                    <span class="step-val">5</span>
                    <span class="step-title">编辑销售计划</span>
                    <span class="step-time">第五步</span>
                </li>

                <li style="width:20%;" class="step-next">
                    <span class="step-deco"></span>
                    <span class="step-val">6</span>
                    <span class="step-title">编辑静态利润</span>
                    <span class="step-time">第六步</span>
                </li>
            </ul>
        </div>

		<div class="result_div" style="width:100%;">
			
			<div style="margin:0 10px 10px 10px; border:1px dashed #ccc;">
				<div id="divProjectTitle" style="margin: 10px; font-size: 16px">
                    <span>暂无信息，请点击编辑添加</span>
				</div>
			</div>

            <div id="divDevelopTable"></div>
			
            <input type="button" value="上一步" class="btn btn_back" style="margin:10px;" id="btnLast" />
            <input type="button" value="保  存" class="btn btn_back" style="margin:10px;" id="btnSave" />
			<input type="button" value="下一步" class="btn btn_back" style="margin:10px;" id="btnNext" />

		</div>

    </div>

    <input type="hidden" id="hId" value="" />
    <input type="hidden" id="hCode" value="" />
    <input type="hidden" id="hVersion" value="" />
    <input type="hidden" id="hProjectName" value="" />
    <input type="hidden" id="hVersionName" value="" />

    <!-- Required Scripts -->
    <script src="../plugins/jQuery/jquery-2.2.3.min.js"></script>
    <script src="../plugins/app/app.js"></script>
    <script src="../plugins/handsontable/handsontable.full.js"></script>
    <script src="../plugins/jsrender/jsrender.min.js"></script>
    <script type="text/x-jsrender" id="tempBreadcrumb">
        <li><a href="project_done.html"><i class="fa fa-bookmark-o"></i> 项目管理入口</a></li>
        <li><a href="project_index.html?id={{:Id}}">项目一览</a></li>
        <li>开发方案</li>
        <li>编辑</li>
        <li class="active">{{:ProjectName}}</li>
    </script>
    <script type="text/x-jsrender" id="tempProjectTitle">
        <span>项目名称：{{:ProjectName}}</span>
        <span style="margin-left:50px;">当前版本：{{:Version}}</span>
    </script>
    <script type="text/x-jsrender" id="tempDevelopTable">
        <div style="margin:0 10px 10px 10px; border:1px dashed #ccc;">
            <div style="margin: 10px; font-size: 16px">
                {{:StageNumber}}、开发方案{{:StageNumber}}期
                <a href="javascript:;" id="aReload_{{:StageNumber}}" style="text-decoration:none; margin-left:20px; font-size:14px;">获取最新</a>
            </div>
            <div id="divExcel_{{:StageNumber}}" style="margin: 10px;"></div>
            <div style="margin: 10px; ">
                容积率规划建筑面积合计：<span id="spanPlanConsArea_{{:StageNumber}}">0</span> 平方米
            </div>
            
        </div>
    </script>
    <script src="../login/js/base.js"></script>
    <script>

        //获取用户账户
        var userName = getCookie("UserName");
        //获取用户信息
        var userInfo = getUserInfo(userName);

        //绑定头像
        document.getElementById("imgUserSmall").src = userInfo.IconName;
        document.getElementById("imgUserLarge").src = userInfo.IconName;

        //绑定昵称
        document.getElementById("spanNickName").innerHTML = userInfo.NickName;
        document.getElementById("pNickName").innerHTML = userInfo.NickName;

        /**
         * 获取网页路径参数
         * @returns {返回请求} 
         */
        $.GetRequest = function () {
            var url = location.search;
            var theRequest = new Object();
            theRequest.count = 0;
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                    theRequest.count++;
                }
            }
            return theRequest;
        }

        //防止二次提交
        var flag = 0;

        $(function () {

            var request = $.GetRequest();
            var id = request["id"];
            var code = request["code"];
            var vn = request["vn"];
            var pn = request["pn"];
            var regInt = /^\d+$/;           //正整数
            if (regInt.test(id) == false) {
                id = 0;
            }
            $("#hId").val(id);
            var regGuid = /^\w{8}-(\w{4}-){3}\w{12}$/;     //GUID
            if (regGuid.test(code) == false) {
                code = "";
            }
            $("#hCode").val(code);
            $("#hVersion").val(vn);

            //获取项目的面包屑
            $.ajax({
                type: "get",
                async: true,
                contentType: "application/json;charset=utf-8",
                url: "api/project.ashx?m_r=" + Math.random(),
                data: {
                    type: "getProBaseInfo",
                    code: code,
                    vn: vn
                },
                dataType: 'json',
                success: function (result) {
                    var jsonObj = eval(result);

                    $("#hProjectName").val(jsonObj[0].ProjectName);
                    $("#hVersionName").val(jsonObj[0].Version);

                    //绑定面包屑
                    var template = $.templates("#tempBreadcrumb");
                    var htmlOutput = template.render(jsonObj[0]);

                    $("#olBreadcrumb").html(htmlOutput);

                    //绑定头部列
                    template = $.templates("#tempProjectTitle");
                    htmlOutput = template.render(jsonObj[0]);
                    $("#divProjectTitle").html(htmlOutput);

                    //获取项目总期数
                    var stageNumber = jsonObj[0].StageNumber;
                    if (stageNumber != "" && stageNumber != "undefined") {
                        BindTable(stageNumber);     //这个方法里的加载都是同步进行的需要注意

                        $("#btnSave").click(function () {
                            SaveData(stageNumber);
                        });

                        $("#btnNext").click(function () {
                            if (confirm("下一步前请先保存，否则系统将不会记录当前编辑结果，请问确认要到下一步么？")) {
                                var id = $("#hId").val();
                                var code = $("#hCode").val();
                                var vn = $("#hVersion").val();
                                window.open("project_develop_step_four.html?r_m=" + Math.random() + "&id=" + id + "&code=" + code + "&vn=" + vn, "_self");
                            }
                        });

                        $("#btnLast").click(function () {
                            var id = $("#hId").val();
                            var code = $("#hCode").val();
                            var vn = $("#hVersion").val();
                            window.open("project_develop_step_two.html?r_m=" + Math.random() + "&id=" + id + "&code=" + code + "&vn=" + vn, "_self");
                        });
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                }
            });
        });


        function SaveData(stageNumber) {
            //Temp
            //var id = $("#hId").val();
            //var code = $("#hCode").val();
            //var vn = $("#hVersion").val();
            //window.open("project_develop_step_four.html?r_m=" + Math.random() + "&id=" + id + "&code=" + code + "&vn=" + vn, "_self");
            //return;

            //定义公共变量
            var jsonNum = [];
            var html = '';
            for (var i = 1; i <= stageNumber; i++) {
                jsonNum.push({ "StageNumber": i });
            }

            //拼接消息
            var stream = [];
            var tempJson;

            var handsontable;
            var data;

            //循环获取每期开发方案
            for (var i = 0; i < jsonNum.length; i++) {
                handsontable = $("#divExcel_" + jsonNum[i].StageNumber).data('handsontable');
                data = handsontable.getData();
                for (var j = 0; j < data.length; j++) {
                    tempJson = { StageNumber: jsonNum[i].StageNumber, ProTypeConfigCode: data[j][1], ConsLandArea: data[j][2], AreaRatio: data[j][3], AvailableArea: data[j][4], AvailableRate: data[j][5] };
                    stream.push(tempJson);
                }
            }

            var code = $("#hCode").val();
            var vn = $("#hVersionName").val();

            if (flag === 0) {
                flag = 1
            }
            else {
                return;
            }

            $.ajax({
                type: "post",
                url: "api/saveDevelop.ashx?projectCode=" + code + "&version=" + vn + "&userCode=",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(stream),
                dataType: "json",
                success: function (result) {
                    if (result === "1" || result === 1) {
                        alert("保存成功！");
                    }
                    else {
                        alert("提交失败！");
                    }
                    flag = 0;
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert("系统错误！");
                    flag = 0;
                }
            });
        }

        function BindTable(stageNumber) {
            //定义公共变量
            var jsonNum = [];
            var html = '';
            for (var i = 1; i <= stageNumber; i++) {
                jsonNum.push({ "StageNumber": i });
            }

            var template;
            var htmlOutput = "";
            for (var i = 0; i < jsonNum.length; i++) {
                template = $.templates("#tempDevelopTable");
                htmlOutput += template.render(jsonNum[i]);
            }

            $("#divDevelopTable").html(htmlOutput);

            var code = $("#hCode").val();
            var vn = $("#hVersion").val();

            $.ajax({
                type: "get",
                async: true,
                contentType: "application/json;charset=utf-8",
                url: "api/project.ashx?m_r=" + Math.random(),
                data: {
                    type: "getLastLandTarget",
                    projectCode: code,
                    vn: vn,
                    stageNumber: stageNumber
                },
                dataType: 'json',
                success: function (lastInfo) {
                    var jsonLast = eval(lastInfo);
                    for (var i = 0; i < jsonLast.length; i++) {
                        $("#spanPlanConsArea_" + jsonLast[i].StageNumber).html(jsonLast[i].PlanConsArea);
                    }
                }
            });

            var date = new Date();
            var mon = date.getMonth() + 1;
            var day = date.getDate();
            var nowDay = date.getFullYear() + "-" + (mon < 10 ? "0" + mon : mon) + "-" + (day < 10 ? "0" + day : day);
            
            for (var i = 0; i < jsonNum.length; i++) {
                //动态绑定获取最新功能
                $("#aReload_" + jsonNum[i].StageNumber).click(function () {
                    var arrayStage = $(this).attr("id").split("_");
                    var stageNumberInner = arrayStage[1];

                    $.ajax({
                        type: "get",
                        async: false,
                        contentType: "application/json;charset=utf-8",
                        url: "api/project.ashx?m_r=" + Math.random(),
                        data: {
                            type: "getLastDevelopmentScheme",
                            projectCode: code,
                            vn: vn,
                            stageNumber: stageNumberInner
                        },
                        dataType: 'json',
                        success: function (lastInfo) {
                            var jsonLast = eval(lastInfo);
                            var handsontable = $("#divExcel_" + stageNumberInner).data('handsontable');
                            handsontable.loadData(jsonLast);
                        }
                    });
                });

                $.ajax({
                    type: "get",
                    async: false,
                    contentType: "application/json;charset=utf-8",
                    url: "api/project.ashx?m_r=" + Math.random(),
                    data: {
                        type: "getLastProduct",
                        code: code,
                        vn: vn,
                        date: nowDay,
                        stage: jsonNum[i].StageNumber
                    },
                    dataType: 'json',
                    success: function (pList) {
                        var jsonList = eval(pList);

                        if (jsonList.length > 0) {
                            var stageNumber = jsonList[0].StageNumber;

                            var data = [];
                            var jsonTemp;
                            for (var j = 0; j < jsonList.length; j++) {
                                jsonTemp = {
                                    "ProTypeName": jsonList[j].ProTypeName,
                                    "ProTypeConfigCode": jsonList[j].Code,
                                    "ConsLandArea": "",
                                    "AreaRatio": "",
                                    "AvailableArea": "",
                                    "AvailableRate": ""
                                }
                                data.push(jsonTemp);
                            }

                            BindExcel("divExcel_" + stageNumber, data, jsonList.length);
                        }

                    }
                });
            }
        }

        function BindExcel(objId, data, maxRowNum) {

            var mergeCell = [];
            var mergeTemp;
            for (var i = 0; i < maxRowNum; i++) {
                mergeTemp = { row: i, col: 0, rowspan: 1, colspan: 2 };
                mergeCell.push(mergeTemp);
            }

            var totalRenderer = function (instance, td, row, col, prop, value, cellProperties) {
                Handsontable.renderers.NumericRenderer.apply(this, arguments);
                td.style.backgroundColor = '#fbfbfb';
            };

            //初始化
            var $container = $("#" + objId);
            var hot = $container.handsontable({
                data: data,
                rowHeaders: true,
                colHeaders: true,
                contextMenu: false,
                manualColumnResize: true,
                manualRowResize: true,
                startRows: 0,
                minRows: 1,
                maxRows: maxRowNum,
                minSpareRows: 1,
                colWidths: [239, 1, 100, 110, 100, 100],
                colHeaders: ['产品类型', '', '建筑面积<span class="num_suf"><span>㎡</span></span>', '产品配比比率<span class="num_suf">%</span>', '可售面积<span class="num_suf"><span>㎡</span></span>', '可售率<span class="num_suf">%</span>'],
                mergeCells: mergeCell,
                columns: [
                    { data: "ProTypeName", readOnly: true },
                    { data: "ProTypeConfigCode", readOnly: true },
                    { data: "ConsLandArea", type: 'numeric', format: '0,0.00' },
                    { data: "AreaRatio", type: 'numeric', format: '0,0.00' },
                    { data: "AvailableArea", type: 'numeric', format: '0,0.00' },
                    { data: "AvailableRate", type: 'numeric', format: '0,0.00' }
                ],
                afterChange: function (changes, source) {
                    if (source !== 'loadData' && changes != null) {
                        AutoTotal(changes, $container, maxRowNum);
                        AutoAvailableRate(changes, $container, maxRowNum);
                        if (source == 'lastTotal') {
                            LastTotal($container, maxRowNum);
                        }
                    }
                },
                cells: function (row, col, prop) {
                    if (row == maxRowNum - 1) {
                        this.readOnly = true;
                        this.renderer = totalRenderer;
                    }
                    if (col == 3 || col == 5) {
                        this.readOnly = true;
                        this.renderer = totalRenderer;
                    }
                }
            });
        }

        function AutoTotal(changes, object, maxRowNum) {
            for (var i = 0; i < changes.length; i++) {
                var prop = changes[i][1];
                switch (prop) {
                    case "ConsLandArea":
                    case "AvailableArea":
                        var handsontable = object.data('handsontable');
                        var data = handsontable.getDataAtProp(prop);
                        var sum = 0;
                        for (var j = 0; j < data.length - 1; j++) {
                            sum += (data[j] == "" || data[j] == null) ? parseFloat(0) : parseFloat(data[j]);
                        }
                        handsontable.setDataAtRowProp(parseInt(maxRowNum) - 1, prop, sum, "loadData");
                        break;
                    default:
                        break;
                }
            }
        }

        //自动计算可售率与产品配比比率
        function AutoAvailableRate(changes, object, maxRowNum) {
            for (var i = 0; i < changes.length; i++) {
                var row = changes[i][0];
                var prop = changes[i][1];

                switch (prop) {
                    case "ConsLandArea":
                    case "AvailableArea":
                        var handsontable = object.data('handsontable');
                        var data = handsontable.getDataAtRow(row);
                        var ar = 0;
                        var ca = typeof (data[2]) == "undefined" || data[2] == null || data[2] == "" ? 0.00 : data[2];
                        var aa = typeof (data[4]) == "undefined" || data[4] == null || data[4] == "" ? 0.00 : data[4];
                        if (ca > 0) {
                            ar = (100.00 * aa / ca).toFixed(2);
                        }
                        else {
                            ar = 0.00;
                        }
                        handsontable.setDataAtRowProp(row, "AvailableRate", ar, "lastTotal");
                        break;
                    default:
                        break;
                }
            }
        }

        function LastTotal(object, maxRowNum) {
            var handsontable = object.data('handsontable');
            var data = handsontable.getDataAtRow(maxRowNum - 1);
            var ar = 0;
            var ca = typeof (data[2]) == "undefined" || data[2] == null || data[2] == "" ? 0.00 : data[2];
            var aa = typeof (data[4]) == "undefined" || data[4] == null || data[4] == "" ? 0.00 : data[4];
            if (ca > 0) {
                ar = (100.00 * aa / ca).toFixed(2);
            }
            else {
                ar = 0.00;
            }
            handsontable.setDataAtRowProp(maxRowNum - 1, "AvailableRate", ar, "loadData");

            data = handsontable.getData();
            var total = typeof (data[maxRowNum - 1][2]) == "undefined" || data[maxRowNum - 1][2] == null || data[maxRowNum - 1][2] == "" ? 0.00 : data[maxRowNum - 1][2];
            for (var i = 0; i < data.length; i++) {
                var ca = typeof (data[i][2]) == "undefined" || data[i][2] == null || data[i][2] == "" ? 0.00 : data[i][2];
                if (total > 0) {
                    ar = (100.00 * ca / total).toFixed(2);
                }
                else {
                    ar = 0.00;
                }
                handsontable.setDataAtRowProp(i, "AreaRatio", ar, "loadData");
            }
        }
    </script>

</body>
</html>